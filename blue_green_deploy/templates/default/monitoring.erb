#!/bin/bash
WORKER=`docker exec -i -t app0 bash -c "pm2 status all"|grep '\[worker\]'|awk -F'│' '{print $6;}'|grep 'online' | wc -l`
DECIDER=`docker exec -i -t app0 bash -c "pm2 status all"|grep '\[decider\]'|awk -F'│' '{print $6;}'|grep 'online' | wc -l`
CRON=`docker exec -i -t app0 bash -c "pm2 status all"|grep '\[cron\]'|awk -F'│' '{print $6;}'|grep 'online' | wc -l`
`/usr/local/bin/aws cloudwatch put-metric-data --metric-name OnlineCount --namespace "APP_Metrics" --dimensions "Env=<%= @env %>,InstanceID=<%= @InstanceID %>,App_name=Worker" --value $WORKER`
`/usr/local/bin/aws cloudwatch put-metric-data --metric-name OnlineCount --namespace "APP_Metrics" --dimensions "Env=<%= @env %>,InstanceID=<%= @InstanceID %>,App_name=Decider" --value $DECIDER`
<% if node[:opsworks][:instance][:layers][0]==node[:submodules][:backend][:layer] -%>
`/usr/local/bin/aws cloudwatch put-metric-data --metric-name OnlineCount --namespace "APP_Metrics" --dimensions "Env=<%= @env %>,InstanceID=<%= @InstanceID %>,App_name=Cron" --value $CRON`
<% end -%>
